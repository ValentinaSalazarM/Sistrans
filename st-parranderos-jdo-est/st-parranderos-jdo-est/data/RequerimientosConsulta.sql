
--RFC1 - MOSTRAR TODOS LOS VISITANTES ATENDIDOS POR UN ESTABLECIMIENTO EN UN RANGO DE FECHAS

SELECT DISTINCT VISITANTE.*
FROM LECTOR
JOIN
    (
        SELECT IDLECTOR, IDVISITANTE
        FROM REGISTRANCARNET
        WHERE FECHA BETWEEN TO_DATE('2019/04/24','yyyy/mm/dd') AND TO_DATE('2020/11/09','yyyy/mm/dd')
    ) INF_VISITAS
ON INF_VISITAS.IDLECTOR = LECTOR.ID
JOIN VISITANTE
ON INF_VISITAS.IDVISITANTE = VISITANTE.IDENTIFICACION
WHERE LECTOR.IDLOCALCOMERCIAL = 'LC104';

--RFC1 - MOSTRAR TODOS LOS VISITANTES ATENDIDOS POR UN ESTABLECIMIENTO EN UNA FECHA

SELECT DISTINCT VISITANTE.*
FROM LECTOR
JOIN
    (
        SELECT IDLECTOR, IDVISITANTE
        FROM REGISTRANCARNET
        WHERE FECHA =  TO_DATE('2019/04/24','yyyy/mm/dd')
    ) INF_VISITAS
ON INF_VISITAS.IDLECTOR = LECTOR.ID
JOIN VISITANTE
ON INF_VISITAS.IDVISITANTE = VISITANTE.IDENTIFICACION
WHERE LECTOR.IDLOCALCOMERCIAL = 'LC104';

--RFC1 - MOSTRAR TODOS LOS VISITANTES ATENDIDOS POR UN ESTABLECIMIENTO EN UN RANGO DE HORAS

SELECT VISITANTE.*, HORA, MINUTO
FROM LECTOR
JOIN
    (
        SELECT IDLECTOR, IDVISITANTE, HORA, MINUTO
        FROM HORARIO
        JOIN REGISTRANCARNET
        ON HORARIO.ID = REGISTRANCARNET.HORAENTRADA
        WHERE FECHA =  TO_DATE('2019/04/24','yyyy/mm/dd')
        AND HORA BETWEEN 12 AND 16
    ) INF_VISITAS
ON INF_VISITAS.IDLECTOR = LECTOR.ID
JOIN VISITANTE
ON INF_VISITAS.IDVISITANTE = VISITANTE.IDENTIFICACION
WHERE LECTOR.IDLOCALCOMERCIAL = 'LC104';

--RFC2 - MOSTRAR LOS 20 ESTABLECIMIENTOS MÁS POPULARES (MÁS VISITADOS) EN UNA FECHA

SELECT LOCALCOMERCIAL.*
FROM LECTOR
JOIN 
    (SELECT *
    FROM
        (SELECT IDLECTOR, COUNT(*) AS NUM_VISITAS
        FROM REGISTRANCARNET
        WHERE FECHA =  TO_DATE('2019/07/19','yyyy/mm/dd')
        GROUP BY IDLECTOR
        ORDER BY NUM_VISITAS DESC)
    WHERE ROWNUM <= 20 
    ) AUX
ON AUX.IDLECTOR = LECTOR.ID
JOIN LOCALCOMERCIAL
ON LECTOR.IDLOCALCOMERCIAL = LOCALCOMERCIAL.IDENTIFICADOR;

--RFC2 - MOSTRAR LOS 20 ESTABLECIMIENTOS MÁS POPULARES (MÁS VISITADOS) EN UN RANGO DE FECHAS
SELECT LOCALCOMERCIAL.*
FROM LECTOR
JOIN 
    (SELECT *
    FROM
        (SELECT IDLECTOR, COUNT(*) AS NUM_VISITAS
        FROM REGISTRANCARNET
        WHERE FECHA BETWEEN TO_DATE('2018/04/24','yyyy/mm/dd') AND TO_DATE('2020/12/09','yyyy/mm/dd')
        GROUP BY IDLECTOR
        ORDER BY NUM_VISITAS DESC)
    WHERE ROWNUM <= 20 
    ) AUX
ON AUX.IDLECTOR = LECTOR.ID
JOIN LOCALCOMERCIAL
ON LECTOR.IDLOCALCOMERCIAL = LOCALCOMERCIAL.IDENTIFICADOR;


--RFC2 - MOSTRAR LOS 20 ESTABLECIMIENTOS MÁS POPULARES (MÁS VISITADOS) EN UN RANGO DE HORAS
SELECT LOCALCOMERCIAL.*, HORA, MINUTO
FROM LECTOR
JOIN 
    (SELECT REGISTRANCARNET.IDLECTOR, HORARIO.HORA, HORARIO.MINUTO
    FROM
        (SELECT IDLECTOR, COUNT(*) AS NUM_VISITAS
        FROM REGISTRANCARNET
        WHERE FECHA =  TO_DATE('2019/07/19','yyyy/mm/dd')
        GROUP BY IDLECTOR
        ORDER BY NUM_VISITAS DESC) INF_VISITAS
    JOIN REGISTRANCARNET
    ON INF_VISITAS.IDLECTOR = REGISTRANCARNET.IDLECTOR
    JOIN HORARIO
    ON REGISTRANCARNET.HORAENTRADA = HORARIO.ID
    WHERE ROWNUM <= 20 AND HORA BETWEEN 14 AND 16
    ) AUX
ON AUX.IDLECTOR = LECTOR.ID
JOIN LOCALCOMERCIAL
ON LECTOR.IDLOCALCOMERCIAL = LOCALCOMERCIAL.IDENTIFICADOR;

--RFC3 - MOSTRAR EL ÍNDICE DE AFORO DEL CENTRO COMERCIAL EN UNA FECHA

SELECT IDCENTROCOMERCIAL, AFORO, NUM_VISITAS
FROM
(SELECT IDCENTROCOMERCIAL, COUNT(*) AS NUM_VISITAS
FROM REGISTRANCARNET JOIN LECTOR
ON REGISTRANCARNET.IDLECTOR = LECTOR.ID
WHERE FECHA =  TO_DATE('2019/07/19','yyyy/mm/dd') AND LECTOR.IDCENTROCOMERCIAL = 5
GROUP BY IDCENTROCOMERCIAL),
(SELECT SUM(AFORO) AS AFOROTOTAL
FROM
((SELECT AFORO
FROM
ASCENSOR JOIN CAPACIDADNORMAL 
ON ASCENSOR.CAPACIDADNORMAL = CAPACIDADNORMAL.ID
WHERE ASCENSOR.IDCENTROCOMERCIAL = 5)
UNION
(SELECT AFORO
FROM
BANO JOIN CAPACIDADNORMAL 
ON BANO.CAPACIDADNORMAL = CAPACIDADNORMAL.ID
WHERE BANO.IDCENTROCOMERCIAL = 5)
UNION
(SELECT AFORO
FROM
LOCALCOMERCIAL JOIN AREA 
ON LOCALCOMERCIAL.AREA = AREA.ID
WHERE LOCALCOMERCIAL.IDCENTROCOMERCIAL = 5)
UNION
(SELECT AFORO
FROM
PARQUEADERO JOIN AREA 
ON PARQUEADERO.AREA = AREA.ID
WHERE PARQUEADERO.IDCENTROCOMERCIAL = 5)));

--RFC3 - MOSTRAR EL ÍNDICE DE AFORO DEL LOCAL COMERCIAL EN UNA FECHA
SELECT LOCALCOMERCIAL.IDENTIFICADOR, AREA.AFORO, NUM_VISITAS, (NUM_VISITAS/AREA.AFORO) * 100 AS INDICE
FROM LOCALCOMERCIAL
JOIN
    (SELECT IDLOCALCOMERCIAL, COUNT(*) AS NUM_VISITAS
    FROM REGISTRANCARNET JOIN LECTOR
    ON REGISTRANCARNET.IDLECTOR = LECTOR.ID
    WHERE FECHA =  TO_DATE('2019/07/19','yyyy/mm/dd') AND LECTOR.IDLOCALCOMERCIAL = 'LC101'
    GROUP BY IDLOCALCOMERCIAL) AUX
ON LOCALCOMERCIAL.IDENTIFICADOR = AUX.IDLOCALCOMERCIAL
JOIN AREA
ON LOCALCOMERCIAL.AREA = AREA.ID;

--RFC3 - MOSTRAR EL ÍNDICE DE AFORO DEL LOCAL COMERCIAL EN UN RANGO DE FECHAS

SELECT *
FROM REGISTRANCARNET
ORDER BY IDLECTOR;
SELECT LOCALCOMERCIAL.IDENTIFICADOR, AREA.AFORO, NUM_VISITAS, (NUM_VISITAS/AREA.AFORO) * 100 AS INDICE
FROM LOCALCOMERCIAL
JOIN
    (SELECT IDLOCALCOMERCIAL, COUNT(*) AS NUM_VISITAS
    FROM REGISTRANCARNET JOIN LECTOR
    ON REGISTRANCARNET.IDLECTOR = LECTOR.ID
    WHERE FECHA BETWEEN TO_DATE('2019/05/19','yyyy/mm/dd') AND TO_DATE('2020/07/20','yyyy/mm/dd') AND LECTOR.IDLOCALCOMERCIAL = 'LC101'
    GROUP BY IDLOCALCOMERCIAL) AUX
ON LOCALCOMERCIAL.IDENTIFICADOR = AUX.IDLOCALCOMERCIAL
JOIN AREA
ON LOCALCOMERCIAL.AREA = AREA.ID;

